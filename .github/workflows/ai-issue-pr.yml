name: AI Issue to PR

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to solve"
        required: true
        type: number
      openai_model:
        description: "OpenAI model identifier"
        required: false
        default: "gpt-4o"
        type: string
      run_smoke_tests:
        description: "Run smoke tests before creating the PR"
        required: false
        type: boolean
        default: false
      require_smoke_success:
        description: "Only create a PR if smoke tests pass"
        required: false
        type: boolean
        default: false
      enable_preview:
        description: "Spin up a Cloudflare tunnel preview environment"
        required: false
        type: boolean
        default: false
      preview_ttl_minutes:
        description: "Minutes to keep the preview environment alive"
        required: false
        type: number
        default: 10

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  build-pr:
    runs-on: ubuntu-latest
    environment: main
    env:
      ISSUE_NUMBER: ${{ inputs.issue_number }}
      AI_BRANCH: ai/issue-${{ inputs.issue_number }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install aider
        run: |
          python -m pip install --upgrade pip
          pip install aider-chat

      - name: Configure git user
        run: |
          git config user.name "ai-automation-bot"
          git config user.email "ai-bot@users.noreply.github.com"

      - name: Fetch issue context
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue view "$ISSUE_NUMBER" --json number,title,body,comments,url > issue.json

      - name: Build AI context pack
        run: |
          python scripts/build_ai_context.py \
            --issue-json issue.json \
            --output ai_context/context.md \
            --files-output ai_context/files.txt

      - name: Prepare working branch
        run: |
          set -euo pipefail
          git fetch origin main
          git checkout -B "$AI_BRANCH" origin/main

      - name: Run aider to apply changes
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AIDER_NO_WEB: "1"
          AIDER_SKIP_PLAYWRIGHT_INSTALL: "1"
        run: |
          set -euo pipefail
          mapfile -t FILES < ai_context/files.txt
          cmd=(aider --yes --no-auto-commits --disable-playwright --no-detect-urls --model "${{ inputs.openai_model }}" --message-file ai_context/context.md)
          if [[ ${#FILES[@]} -gt 0 ]]; then
            cmd+=("${FILES[@]}")
          fi
          "${cmd[@]}"

      - name: Prepare branch with AI changes
        id: prepare_branch
        run: |
          set -euo pipefail
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ISSUE_TITLE="$(jq -r '.title' issue.json)"
          BRANCH="$AI_BRANCH"

          git add -A
          git commit -m "AI: address #${ISSUE_NUMBER}"
          git push -u origin "$BRANCH" --force-with-lease

          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "issue_title=${ISSUE_TITLE}" >> "$GITHUB_OUTPUT"

      - name: Start preview environment
        if: ${{ inputs.enable_preview && steps.prepare_branch.outputs.changed == 'true' }}
        id: preview_start
        env:
          PREVIEW_PROJECT_NAME: preview-${{ github.run_id }}-${{ github.run_attempt }}-issue-${{ inputs.issue_number }}
          PREVIEW_BRANCH: ${{ env.AI_BRANCH }}
        run: |
          bash scripts/preview_start.sh

      - name: Preview URL
        if: ${{ inputs.enable_preview && steps.preview_start.outcome == 'success' }}
        run: |
          echo "Preview URL (expires in ${{ inputs.preview_ttl_minutes }} minutes): ${{ steps.preview_start.outputs.tunnel_url }}"

      - name: Run smoke tests
        id: smoke
        if: ${{ inputs.run_smoke_tests && steps.prepare_branch.outputs.changed == 'true' }}
        continue-on-error: true
        env:
          DATABASE_URL: postgresql://betapp:ci-test@db:5432/betdb
          POSTGRES_PASSWORD: ci-test
          SESSION_SECRET: test-session-secret
          ADMIN_USERNAME: admin
          ADMIN_PASSWORD: changeme
          ADMIN_ACCESS_KEY: changeme
          API_URL: http://web:8000
          TARGET_CHANNEL: ci-smoke
          WEB_UI_URL: http://localhost:8000
          DISCORD_TOKEN: placeholder
          OPENAI_API_KEY: placeholder
        run: |
          bash scripts/ci_smoke.sh

      - name: Create pull request
        if: ${{ steps.prepare_branch.outputs.changed == 'true' && ( !inputs.run_smoke_tests || steps.smoke.outcome == 'success' || inputs.require_smoke_success == false) }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ISSUE_TITLE="${{ steps.prepare_branch.outputs.issue_title }}"
          BRANCH="${{ steps.prepare_branch.outputs.branch }}"

          sed "s/{{ISSUE_NUMBER}}/${ISSUE_NUMBER}/g" \
            .github/pr_template.md > ai_context/pr_body.md

          gh api "repos/${{ github.repository }}/pulls" \
            -f head="$BRANCH" \
            -f base="main" \
            -f title="AI: address #${ISSUE_NUMBER} â€“ ${ISSUE_TITLE}" \
            -F body=@ai_context/pr_body.md \
            -F draft=true

      - name: Keep preview alive
        if: ${{ inputs.enable_preview && steps.preview_start.outcome == 'success' }}
        run: |
          sleep $(( inputs.preview_ttl_minutes * 60 ))

      - name: Cleanup preview environment
        if: ${{ always() && inputs.enable_preview && steps.preview_start.outcome == 'success' }}
        env:
          PREVIEW_STATE_FILE: ${{ steps.preview_start.outputs.preview_state_file }}
        run: |
          bash scripts/preview_cleanup.sh "$PREVIEW_STATE_FILE"
