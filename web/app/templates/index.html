{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Open Wagers</h1>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
  {% for user in users %}
  <div class="bg-white rounded-xl shadow p-4">
    <!-- User info -->
    <div class="flex items-center gap-3 mb-3">
      {% if user.profile_pic_url %}
      <img src="{{ user.profile_pic_url }}" alt="{{ user.display_name }}" class="w-10 h-10 rounded-full">
      {% else %}
      <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-sm font-semibold">
        {{ user.display_name|default('?')|first }}
      </div>
      {% endif %}
      <h2 class="text-xl font-semibold">{{ user.display_name }}</h2>
    </div>

    {% if user.active_wagers %}
    <!-- Wagers -->
    <div class="space-y-3 mt-3">
      {% for wager in user.active_wagers %}
        {% if wager.status != 'removed' %}
        <div class="relative border p-3 rounded-xl flex justify-between items-center group">
          <!-- Status Badge -->
          <div class="absolute -top-2 -left-2">
            {% if wager.status == 'won' %}
              <span class="bg-green-500 text-white text-xs font-bold px-2 py-1 rounded shadow">WON</span>
            {% elif wager.status == 'lost' %}
              <span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded shadow">LOST</span>
            {% else %}
              <span class="bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded shadow">OPEN</span>
            {% endif %}
          </div>

          <!-- Description + Amount/Line + Action Buttons -->
          <div>
            <p class="font-medium">{{ wager.description }}</p>
            <p class="text-xs text-gray-500">Placed {{ wager.created_at.strftime('%b %d, %Y') if wager.created_at else '‚Äî' }}</p>
            <p class="text-sm text-gray-600">Amount: ${{ '{:,.2f}'.format(wager.amount) }} | Line: {{ wager.line }}</p>
            {% if wager.payout is not none %}
            <p class="text-sm text-gray-600">Payout: ${{ '{:,.2f}'.format(wager.payout) }}</p>
            {% endif %}
            {% if wager.matchup and (not wager.legs or wager.legs|length <= 1) %}
            {% set home = wager.matchup.home_team %}
            {% set away = wager.matchup.away_team %}
            <div class="mt-3">
              <div class="flex items-center gap-4 bg-gray-50 rounded-lg px-3 py-2">
                <div class="flex items-center gap-2">
                  {% if home and home.logo_url %}
                  <img src="{{ home.logo_url }}" alt="{{ home.display_name or home.name }} logo" class="w-8 h-8 object-contain rounded-full border"/>
                  {% else %}
                  <span class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500">‚Äî</span>
                  {% endif %}
                  <span class="font-semibold text-sm">{{ home.display_name or home.name if home else 'TBD' }}</span>
                </div>
                <span class="text-xs text-gray-500 uppercase tracking-wide">vs</span>
                <div class="flex items-center gap-2">
                  {% if away and away.logo_url %}
                  <img src="{{ away.logo_url }}" alt="{{ away.display_name or away.name }} logo" class="w-8 h-8 object-contain rounded-full border"/>
                  {% else %}
                  <span class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500">‚Äî</span>
                  {% endif %}
                  <span class="font-semibold text-sm">{{ away.display_name or away.name if away else 'TBD' }}</span>
                </div>
              </div>
              {% if wager.matchup.league or wager.matchup.scheduled_at %}
              <p class="text-xs text-gray-500 mt-1">
                {% if wager.matchup.league %}
                  {{ wager.matchup.league.display_name or wager.matchup.league.name }}
                {% endif %}
                {% if wager.matchup.scheduled_at %}
                  ¬∑ {{ wager.matchup.scheduled_at.strftime('%b %d, %I:%M %p') }}
                {% endif %}
              </p>
              {% endif %}
            </div>
            {% endif %}
            {% if wager.legs %}
            <div class="mt-3 space-y-2">
              {% for leg in wager.legs %}
                <div class="bg-gray-100 rounded-lg px-3 py-2 flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-800">{{ leg.description }}</p>
                  {% if leg.matched_teams %}
                  <div class="flex items-center gap-2 mt-1">
                    {% for team in leg.matched_teams %}
                    <div class="flex items-center gap-1">
                      {% if team.logo_url %}
                      <img src="{{ team.logo_url }}" alt="{{ team.display_name }} logo" class="w-6 h-6 rounded-full object-contain border"/>
                      {% endif %}
                      <span class="text-xs text-gray-600">{{ team.display_name }}</span>
                    </div>
                    {% endfor %}
                  </div>
                  {% endif %}
                  <span class="text-xs font-semibold px-2 py-0.5 rounded-full
                    {% if leg.status == 'won' %} bg-green-500 text-white
                    {% elif leg.status == 'lost' %} bg-red-500 text-white
                    {% else %} bg-blue-500 text-white {% endif %}">
                    {{ leg.status|upper }}
                  </span>
                </div>
                <form method="post" action="/wagers/{{ wager.id }}/legs/{{ leg.id }}/status" class="flex gap-2">
                  <button name="status" value="won"
                          class="transition transform hover:scale-125 bg-green-500 text-white px-2 py-1 rounded-full">‚úÖ</button>
                  <button name="status" value="lost"
                          class="transition transform hover:scale-125 bg-red-500 text-white px-2 py-1 rounded-full">‚ùå</button>
                </form>
              </div>
              {% endfor %}
            </div>
            {% endif %}

            <div class="hidden group-hover:flex gap-3 mt-2 transition ease-in-out duration-200">
              <form method="post" action="/wagers/{{ wager.id }}/status" class="flex gap-2">
                <button name="status" value="won"
                        class="transition transform hover:scale-125 bg-green-500 text-white px-3 py-1 rounded-full">‚úÖ</button>
                <button name="status" value="lost"
                        class="transition transform hover:scale-125 bg-red-500 text-white px-3 py-1 rounded-full">‚ùå</button>
                <button name="status" value="removed"
                        onclick="return confirm('Are you sure you want to remove this wager?')"
                        class="transition transform hover:scale-125 bg-gray-300 px-3 py-1 rounded-full">üóë</button>
              </form>
              <form method="post" action="/wagers/{{ wager.id }}/archive">
                <input type="hidden" name="archived" value="true">
                <input type="hidden" name="redirect_to" value="/">
                <button class="transition transform hover:scale-105 bg-yellow-500 text-white px-3 py-1 rounded-full">Archive</button>
              </form>
            </div>
          </div>

          <!-- Status Icon (big on the right) -->
          <div class="text-4xl">
            {% if wager.status == 'won' %}
              <span class="text-green-500">‚úÖ</span>
            {% elif wager.status == 'lost' %}
              <span class="text-red-500">‚ùå</span>
            {% else %}
              <span class="text-gray-300">‚Äî</span>
            {% endif %}
          </div>
        </div>
        {% endif %}
      {% endfor %}
    </div>
    {% else %}
    <p class="text-sm text-gray-500 italic mt-3">No active wagers right now.</p>
    {% endif %}
  </div>
  {% endfor %}
</div>
{% endblock %}
