{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Player Performance</h1>
<p class="text-sm text-gray-600 mb-6">Overall record and profitability for each player based on finished wagers.</p>

<div class="overflow-x-auto bg-white rounded-xl shadow mb-8">
  <table class="min-w-full divide-y divide-gray-200 text-sm">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-4 py-3 text-left font-semibold text-gray-700">Player</th>
        <th class="px-4 py-3 text-right font-semibold text-gray-700">Wagers</th>
        <th class="px-4 py-3 text-right font-semibold text-gray-700">Wins</th>
        <th class="px-4 py-3 text-right font-semibold text-gray-700">Losses</th>
        <th class="px-4 py-3 text-right font-semibold text-gray-700">Open</th>
        <th class="px-4 py-3 text-right font-semibold text-gray-700">Archived</th>
        <th class="px-4 py-3 text-right font-semibold text-gray-700">Win %</th>
        <th class="px-4 py-3 text-right font-semibold text-gray-700">Staked</th>
        <th class="px-4 py-3 text-right font-semibold text-gray-700">Profit</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      {% for stat in player_stats %}
      <tr>
        <td class="px-4 py-3 font-medium text-gray-900 flex items-center gap-3">
          <img src="{{ stat.user.profile_pic_url }}" alt="{{ stat.user.display_name }}" class="w-8 h-8 rounded-full">
          <span>{{ stat.user.display_name }}</span>
        </td>
        <td class="px-4 py-3 text-right text-gray-700">{{ stat.total }}</td>
        <td class="px-4 py-3 text-right text-green-600 font-semibold">{{ stat.wins }}</td>
        <td class="px-4 py-3 text-right text-red-500 font-semibold">{{ stat.losses }}</td>
        <td class="px-4 py-3 text-right text-gray-600">{{ stat.open }}</td>
        <td class="px-4 py-3 text-right text-gray-600">{{ stat.archived }}</td>
        <td class="px-4 py-3 text-right text-gray-700">{{ '{:.1f}%'.format(stat.win_rate) }}</td>
        <td class="px-4 py-3 text-right text-gray-700">${{ '{:,.2f}'.format(stat.staked) }}</td>
        <td class="px-4 py-3 text-right font-semibold {{ 'text-green-600' if stat.profit >= 0 else 'text-red-500' }}">${{ '{:,.2f}'.format(stat.profit) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<h2 class="text-xl font-semibold mb-3">Performance Over Time</h2>
{% if has_chart %}
<div class="flex items-center gap-2 mb-3">
  <button type="button" data-chart="profit" aria-pressed="true"
          class="chart-tab px-3 py-1.5 rounded-full text-sm font-medium bg-blue-600 text-white">
    Profit / Loss
  </button>
  <button type="button" data-chart="bets" aria-pressed="false"
          class="chart-tab px-3 py-1.5 rounded-full text-sm font-medium bg-gray-200 text-gray-700">
    Bets Placed
  </button>
</div>
<div class="bg-white rounded-xl shadow p-4">
  <canvas id="profit-chart" height="120"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script id="chart-data" type="application/json">{{ chart_payload | safe }}</script>
<script>
  const chartDataElement = document.getElementById('chart-data');
  const chartConfig = JSON.parse(chartDataElement.textContent || '{}');
  const datasetsByKey = {
    profit: chartConfig.profit || [],
    bets: chartConfig.bets || [],
  };
  const palette = ['#2563eb', '#dc2626', '#16a34a', '#9333ea', '#f97316', '#0891b2'];

  const prepareDatasets = (datasets) => datasets.map((dataset, index) => {
    const color = dataset.borderColor || palette[index % palette.length];
    return {
      ...dataset,
      borderWidth: 2,
      fill: false,
      pointRadius: 3,
      borderColor: color,
      backgroundColor: dataset.backgroundColor || color,
    };
  });

  const defaultKey = datasetsByKey.profit.length ? 'profit' : 'bets';
  const context = document.getElementById('profit-chart').getContext('2d');
  const chart = new Chart(context, {
    type: 'line',
    data: {
      datasets: prepareDatasets(datasetsByKey[defaultKey] || []),
    },
    options: {
      parsing: false,
      responsive: true,
      interaction: {
        mode: 'nearest',
        intersect: false,
      },
      scales: {
        x: {
          type: 'time',
          time: {
            tooltipFormat: 'PP',
            unit: 'day',
            displayFormats: {
              day: 'MMM d',
            },
          },
          title: {
            display: true,
            text: 'Date',
          },
        },
        y: {
          beginAtZero: defaultKey === 'bets',
          title: {
            display: true,
            text: defaultKey === 'bets' ? 'Bets Placed' : 'Daily Profit / Loss ($)',
          },
        },
      },
      plugins: {
        tooltip: {
          callbacks: {
            label(context) {
              const value = context.parsed.y ?? 0;
              if (context.dataset.metric === 'bets') {
                return `${context.dataset.label}: ${value}`;
              }
              return `${context.dataset.label}: $${value.toFixed(2)}`;
            },
          },
        },
        legend: {
          position: 'bottom',
        },
      },
    },
  });

  const tabs = document.querySelectorAll('.chart-tab');
  const activateTab = (key) => {
    tabs.forEach((tab) => {
      const isActive = tab.dataset.chart === key;
      tab.classList.toggle('bg-blue-600', isActive);
      tab.classList.toggle('text-white', isActive);
      tab.classList.toggle('bg-gray-200', !isActive);
      tab.classList.toggle('text-gray-700', !isActive);
      tab.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });

    chart.data.datasets = prepareDatasets(datasetsByKey[key] || []);
    chart.options.scales.y.beginAtZero = key === 'bets';
    chart.options.scales.y.title.text = key === 'bets'
      ? 'Bets Placed'
      : 'Daily Profit / Loss ($)';
    chart.update();
  };

  tabs.forEach((tab) => {
    tab.addEventListener('click', () => activateTab(tab.dataset.chart));
  });

  activateTab(defaultKey);
</script>
{% else %}
<p class="text-sm text-gray-500">No completed wagers yetâ€”profit chart will appear once bets are graded.</p>
{% endif %}
{% endblock %}
